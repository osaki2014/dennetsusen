<!DOCTYPE html>
<html lang="ja">
  <!-- Firebase SDKï¼ˆäº’æ›ç‰ˆï¼‰-->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<head>
  <meta charset="UTF-8" />
  <title>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ - Geminiåˆ†é¡ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f5;          /* ç™½ï¼‹ã”ãè–„ã„ã‚°ãƒ¬ãƒ¼åŸºèª¿ */
      --card: #ffffff;
      --ink: #222222;
      --accent: #555555;      /* ãƒœã‚¿ãƒ³ãªã©ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚‚ã‚°ãƒ¬ãƒ¼ç³»ã« */
      --accent-soft: #e5e5e5; /* ãƒãƒƒã‚¸ãªã©ã®æ·¡ã„ã‚°ãƒ¬ãƒ¼ */
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      /* é’ã¿ã‚’ã‚„ã‚ã¦ãƒ¢ãƒãƒˆãƒ¼ãƒ³ã®ã‚„ã‚ã‚‰ã‹ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã« */
      background: radial-gradient(circle at top, #ffffff 0, #f5f5f5 40%, #e5e5e5 100%);
      color: var(--ink);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid #d4d4d8; /* ã‚°ãƒ¬ãƒ¼ç³»ã« */
      padding: 8px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* QRã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
    .qr-button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #d4d4d8; /* ãƒ¢ãƒãƒˆãƒ¼ãƒ³ */
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
    }
    .qr-button:hover {
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.06); /* é’ç³»ã®å…‰æ²¢ã‚’ã‚„ã‚ã‚‹ */
    }
    .qr-icon {
      width: 20px;
      height: 20px;
      /* QRè‡ªä½“ã¯é»’ã¨ç™½ã ã‘ãªã®ã§ãã®ã¾ã¾ */
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect width='40' height='40' fill='%23ffffff'/><rect x='3' y='3' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='23' y='3' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='3' y='23' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='7' y='7' width='6' height='6' fill='%23000000'/><rect x='27' y='7' width='6' height='6' fill='%23000000'/><rect x='7' y='27' width='6' height='6' fill='%23000000'/><rect x='22' y='22' width='4' height='4' fill='%23000000'/><rect x='30' y='22' width='3' height='7' fill='%23000000'/><rect x='22' y='30' width='7' height='3' fill='%23000000'/></svg>");
      background-size: cover;
      background-position: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
    }
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    label {
      font-size: 0.8rem;
      color: #555555; /* é’ã¿ã®ã‚ã‚‹ã‚°ãƒ¬ãƒ¼ã‹ã‚‰ä¸­æ€§ã‚°ãƒ¬ãƒ¼ã¸ */
      white-space: nowrap;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    select {
      font: inherit;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;  /* é’ã¿ã‚’æ¶ˆã™ */
      min-width: 120px;
      background: #fff;
      outline: none;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.06); /* ä¸­æ€§ã®æ·¡ã„å½± */
    }
    button {
      font: inherit;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--accent);  /* ã‚°ãƒ¬ãƒ¼ã®å®Ÿé¨“å®¤ãƒœã‚¿ãƒ³ */
      color: #fff;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #d4d4d8;
      color: #555555;
    }
    .btn-ghost-danger {
      background: transparent;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }

    main {
      display: grid;
      grid-template-columns: minmax(260px, 380px) minmax(0, 1fr);
      gap: 16px;
      padding: 12px 16px 24px;
    }
    @media (max-width: 800px) {
      main { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06); /* å½±ã‚‚å°‘ã—å¼±ã‚ã« */
      padding: 14px 16px 16px;
      border: 1px solid #d4d4d8;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .panel p.hint {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* å³å´ãƒ‘ãƒãƒ«ã‚’é»’æ¿ã«ï¼ˆã“ã“ã‹ã‚‰ä¸‹ã® board-panel é–¢é€£ã¯ã€Œãã®ã¾ã¾ã€ï¼‰ */
    .panel.board-panel {
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.14) 0, transparent 40%),
        radial-gradient(circle at 90% 100%, rgba(255,255,255,0.06) 0, transparent 45%),
        linear-gradient(135deg, #253c30 0%, #07130b 70%, #020305 100%);
      border-color: #3f4f3a;
      color: #f9fbe7;
      box-shadow:
        0 0 0 6px #8b5a2b,
        0 0 0 10px #d1a66b,
        0 18px 30px rgba(0,0,0,0.35);
    }
    .panel.board-panel h2 {
      color: #fefce8;
    }
    .panel.board-panel p.hint {
      color: #e5f2d0;
    }
    .panel.board-panel .btn-ghost {
      border-color: rgba(226, 232, 240, 0.7);
      background: rgba(255, 255, 255, 0.12);
      color: #f9fafb;
    }
    .panel.board-panel .btn-ghost-danger {
      border-color: rgba(252, 165, 165, 0.85);
      background: rgba(248, 113, 113, 0.12);
      color: #fee2e2;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      ;
    }
    .field-row > * {
      flex: 1 1 0;
      min-width: 0;
    }
    .field-row.small-gap {
      gap: 6px;
      align-items: center;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d4d4d8;
      font: inherit;
      outline: none;
      background: #ffffff;
    }
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.06);
    }

    .status {
      font-size: 0.8rem;
      color: #6b7280;
      min-height: 1.2em;
    }
    .status.error { color: var(--danger); }

    /* ãƒ‡ãƒ¼ã‚¿ãƒœãƒ¼ãƒ‰ï¼ˆé»’æ¿ã®ä¸Šã«é€æ˜ãªè²¼ã‚Šä»˜ã‘ã‚¨ãƒªã‚¢ï¼‰ */
    .board {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      overflow-x: auto;
      padding: 10px 4px 4px;
      border-radius: 14px;
      background: transparent;
      box-shadow: none;
      border: none;
    }

    .column {
      flex: 1;
      min-width: 200px;
      background: rgba(15, 23, 42, 0.02);
      border-radius: 14px;
      padding: 6px 6px 10px;
      border: 1px dashed rgba(226, 232, 240, 0.25);
      display: flex;
      flex-direction: column;
    }
    .column-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: #f9fbe7;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .column-count {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.18);
      color: #e2f3d2;
    }
    .column-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 2px;
      overflow-y: visible;
    }

    .note {
      position: relative;
      padding: 12px 12px 26px;
      border-radius: 10px;
      /* ä»˜ç®‹ã®è‰²ã¯é»’æ¿ã‚¨ãƒªã‚¢ã®é›°å›²æ°—ã¨ã—ã¦ãã®ã¾ã¾æ®‹ã—ã¦ã„ã¾ã™ */
      background: #fef9c3;
      box-shadow:
        0 6px 10px rgba(15, 23, 42, 0.3),
        inset 0 0 0 1px rgba(148, 163, 184, 0.2);
      font-size: 0.85rem;
      transform: rotate(-1.5deg);
      transform-origin: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      cursor: default;
      word-break: break-word;
      overflow-wrap: anywhere;
      color: #111111;  /* ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ¼ãƒ‰å†…ã®æ–‡å­—è‰²ã¯é»’ */
    }
    .note:nth-child(2n) {
      transform: rotate(1.3deg);
      background: #bfdbfe;
    }
    .note:nth-child(3n) {
      transform: rotate(-0.8deg);
      background: #bbf7d0;
    }
    .note:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow:
        0 10px 18px rgba(0, 0, 0, 0.4),
        inset 0 0 0 1px rgba(148, 163, 184, 0.25);
    }
    .note-author {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #1e293b;
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .note-category {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.12);
      color: #020617;
    }
    .note-text {
      white-space: pre-wrap;
      margin-bottom: 4px;
    }
    .note-meta {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #475569;
      line-height: 1.4;
    }

    .note-footer {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
      font-size: 0.75rem;
    }
    .note-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.8);
      font-size: 0.7rem;
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .note-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .note-btn-like {
      border-color: #bfdbfe;
      background: #eff6ff;
    }
    .note-btn-del {
      border-color: #fecaca;
      background: #fee2e2;
      color: #b91c1c;
    }

    .note-id {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 0.65rem;
      opacity: 0.5;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft); /* ã‚°ãƒ¬ãƒ¼ç³»ãƒãƒƒã‚¸ã« */
      color: #404040;
    }

    .chk-label {
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    /* æ¸¬å®šå€¤ãƒ†ãƒ¼ãƒ–ãƒ«ã®å´©ã‚Œé˜²æ­¢ */
    .measure-table {
      display: grid;
      grid-template-columns: 60px 1fr 1fr 1fr;
      gap: 6px;
      width: 100%;
      margin-top: 4px;
    }
    .measure-table input {
      width: 100%;
      min-width: 0;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d4d4d8;
      font-size: 0.85rem;
    }
    .measure-table div {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }

    /* QRãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒªã‚µã‚¤ã‚ºå¯¾å¿œ + QRæ‹¡å¤§ï¼‰ */
    #qrOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #qrOverlay.active {
      display: flex;
    }
    .qr-modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
      text-align: center;
      max-width: 90vw;
      width: min(90vw, 440px);
      resize: both;
      overflow: auto;
      cursor: default;
    }
    .qr-modal h2 {
      margin: 0 0 4px;
      font-size: 0.95rem;
    }
    .qr-modal p {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    #qrContainer {
      margin: 8px auto 12px;
      width: 100%;
      max-width: 600px;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #qrContainer canvas,
    #qrContainer img {
      width: 100%;
      height: 100%;
      display: block;
    }
    #qrClose {
      font-size: 0.8rem;
    }
        /* ã‚«ãƒ¼ãƒ‰å†…ã«è¡¨ç¤ºã™ã‚‹è¨ˆæ¸¬å€¤ãƒ†ãƒ¼ãƒ–ãƒ« */
        .note-measure {
      margin-top: 6px;
      padding: 4px 6px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.9);  /* ä»˜ç®‹ã®ä¸Šã«ç™½ã„å°ã‚«ãƒ¼ãƒ‰ */
    }
    .note-measure-title {
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0 0 2px;
      color: #374151;
    }
    .measure-board-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }
    .measure-board-table th,
    .measure-board-table td {
      padding: 2px 4px;
      text-align: center;
      white-space: nowrap;
    }
    .measure-board-table thead th {
      border-bottom: 1px solid rgba(148, 163, 184, 0.6);
      font-weight: 600;
    }
    .measure-board-table tbody tr + tr td,
    .measure-board-table tbody tr + tr th {
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
    }
    .measure-board-table.secondary th {
      text-align: center;
    }
  </style>
</head>

<body>
<header>
  <h1>
    <button id="qrButton" class="qr-button" type="button" aria-label="QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">
      <span class="qr-icon"></span>
    </button>
    <span>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ï¼ˆGeminiï¼‰</span>
  </h1>
  <!-- ãƒ€ãƒŸãƒ¼ãƒ•ã‚©ãƒ¼ãƒ : Enter ã§å‹æ‰‹ã«é€ä¿¡ã•ã‚Œãªã„ã‚ˆã†ã« -->
  <form class="toolbar" onsubmit="return false;">
    <div class="toolbar-group">
      <label for="apiKey">Gemini APIã‚­ãƒ¼</label>
      <input id="apiKey" type="password" placeholder="AIza..." autocomplete="off" />
    </div>
    <div class="toolbar-group">
      <label for="categories">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</label>
      <input id="categories" type="text" value="è³ªå•, æ„Ÿæƒ³, æ”¹å–„æ¡ˆ, ãã®ä»–" />
    </div>
    <button id="classifyBtn" class="btn-primary" type="button">
      ğŸ” åˆ†é¡ã™ã‚‹
    </button>
  </form>
</header>

<main>
  <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
  <section class="panel">
    <h2>âœ æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿</h2>
    <p class="hint">å¿…è¦ãªé …ç›®ã‚’å…¥åŠ›ã—ã€å€‹äººã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>

    <!-- åå‰ãƒ»ç­ -->
    <div class="field-row">
      <div class="field-group">
        <label for="nameInput">åå‰ï¼ˆä»»æ„ï¼‰</label>
        <input id="nameInput" type="text" placeholder="ãŸã‚ã† ãªã©" />
      </div>
      <div class="field-group">
        <label for="teamInput">ç­</label>
        <select id="teamInput">
          <option value="">é¸æŠ</option>
          <option>1ç­</option><option>2ç­</option><option>3ç­</option>
          <option>4ç­</option><option>5ç­</option><option>6ç­</option>
          <option>7ç­</option><option>8ç­</option><option>9ç­</option><option>10ç­</option>
        </select>
      </div>
    </div>

    <!-- ãƒ‹ã‚¯ãƒ­ãƒ ç·šï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰ -->
    <div class="field-group">
      <label>ãƒ‹ã‚¯ãƒ­ãƒ ç·š</label>
      <div class="field-row small-gap">
        <label class="chk-label">
          <input id="nichrome02" type="radio" name="nichromeType" />0.2mm
        </label>
        <label class="chk-label">
          <input id="nichrome04" type="radio" name="nichromeType" />0.4mm
        </label>
        <input id="nichromeLen" type="number" min="0" step="1" placeholder="é•·ã•(mm)" />
      </div>
    </div>

    <!-- é›»æ± ï¼ˆã„ãšã‚Œã‹1ã¤ã ã‘é¸æŠï¼‰ -->
    <div class="field-group">
      <label>é›»æ± ï¼ˆã©ã‚Œã‹1ã¤ï¼‰</label>
      <div class="field-row small-gap">
        <label class="chk-label">
          <input id="batSingle" type="radio" name="batteryType" />1å€‹
        </label>
        <label class="chk-label">
          <input id="batSeries" type="radio" name="batteryType" />ç›´åˆ—
        </label>
        <label class="chk-label">
          <input id="batParallel" type="radio" name="batteryType" />ä¸¦åˆ—
        </label>
      </div>
    </div>

    <!-- æ¸¬å®šå€¤ -->
    <div class="field-group">
      <label>æ¸¬å®šå€¤ï¼ˆé–‹å§‹ï¼çµ‚äº†ï¼‰</label>
      <div class="measure-table">
        <div></div><div>æ°´æ¸© â„ƒ</div><div>é›»åœ§ V</div><div>é›»æµ</div>

        <div>é–‹å§‹</div>
        <input id="s_temp" type="number" step="0.1" />
        <input id="s_volt" type="number" step="0.1" />
        <input id="s_amp" type="number" step="0.1" />

        <div>çµ‚äº†</div>
        <input id="e_temp" type="number" step="0.1" />
        <input id="e_volt" type="number" step="0.1" />
        <input id="e_amp" type="number" step="0.1" />
      </div>
      <p class="hint">â€» åŠè§’æ•°å­—ã§å°æ•°ç¬¬1ä½ã¾ã§å…¥åŠ›ã§ãã¾ã™</p>
    </div>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰ -->
    <div class="field-group">
      <label for="commentInput">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
      <textarea id="commentInput" placeholder="ã“ã“ã«æ„è¦‹ã‚„æ„Ÿæƒ³ã€è³ªå•ãªã©ã‚’æ›¸ã„ã¦ã‚‚OKã§ã™"></textarea>
    </div>

    <div class="field-row" style="align-items:center; margin-top:4px;">
      <button id="addBtn" class="btn-ghost" type="button"> ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ã€‚ğŸ“¤</button>
      <div id="formStatus" class="status"></div>
    </div>

    <hr style="margin:10px 0; border:none; border-top:1px dashed #e2e8f0;" />

    <p class="hint">
      ä¸Šã®ã€Œåˆ†é¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ Gemini ãŒ
      <span class="badge">ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</span>ã—ã¾ã™ã€‚
    </p>
  </section>

  <!-- ãƒœãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆé»’æ¿ï¼‰ -->
  <section class="panel board-panel">
    <h2>ğŸ“Œ ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰</h2>

    <!-- ä¿å­˜ãƒ»å‰Šé™¤ãƒ»ã„ã„ã­ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
    <div class="field-row" style="justify-content:flex-end; margin-bottom:4px;">
      <button id="exportBtn" class="btn-ghost" type="button">ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
      <button id="resetLikesBtn" class="btn-ghost" type="button">ğŸ’— ã„ã„ã­ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="clearBtn" class="btn-ghost-danger" type="button">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    </div>

    <p class="hint" id="boardHint">
      ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    </p>
    <div id="board" class="board"></div>
  </section>
</main>

<!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qrOverlay">
  <div class="qr-modal">
    <h2>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ å‚åŠ ç”¨QRã‚³ãƒ¼ãƒ‰</h2>
    <p>ã‚¹ãƒãƒ›ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚</p>
    <div id="qrContainer"></div>
    <button id="qrClose" class="btn-ghost" type="button">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
  // ==== QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ====
  const QR_URL = "https://osaki2014.github.io/dennetsusen/";
  const qrButton = document.getElementById("qrButton");
  const qrOverlay = document.getElementById("qrOverlay");
  const qrClose = document.getElementById("qrClose");
  const qrContainer = document.getElementById("qrContainer");
  let qrInstance = null;

  qrButton.addEventListener("click", () => {
    if (!qrInstance) {
      qrInstance = new QRCode(qrContainer, {
        text: QR_URL,
        width: 360,
        height: 360
      });
    }
    qrOverlay.classList.add("active");
  });

  qrClose.addEventListener("click", () => {
    qrOverlay.classList.remove("active");
  });

  qrOverlay.addEventListener("click", (e) => {
    if (e.target === qrOverlay) {
      qrOverlay.classList.remove("active");
    }
  });

  // ==== Firebase è¨­å®š ====
  const firebaseConfig = {
    apiKey: "AIzaSyCPgjXJw9HQ2AUMzgN4O16s7UYjDllO87I",
    authDomain: "aifusen-class.firebaseapp.com",
    projectId: "aifusen-class",
    storageBucket: "aifusen-class.appspot.com",
    messagingSenderId: "414270455525",
    appId: "1:414270455525:web:95444f14ee8306b6af1e0c",
    measurementId: "G-H74HN1KZTY"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ==== ãƒ‡ãƒ¼ã‚¿ç®¡ç† ====
  const notes = [];

  const nameInput = document.getElementById("nameInput");
  const teamInput = document.getElementById("teamInput");
  const commentInput = document.getElementById("commentInput");

  const nichrome02 = document.getElementById("nichrome02");
  const nichrome04 = document.getElementById("nichrome04");
  const nichromeLen = document.getElementById("nichromeLen");

  const batSingle = document.getElementById("batSingle");
  const batSeries = document.getElementById("batSeries");
  const batParallel = document.getElementById("batParallel");

  const sTemp = document.getElementById("s_temp");
  const sVolt = document.getElementById("s_volt");
  const sAmp  = document.getElementById("s_amp");
  const eTemp = document.getElementById("e_temp");
  const eVolt = document.getElementById("e_volt");
  const eAmp  = document.getElementById("e_amp");

  const addBtn = document.getElementById("addBtn");
  const formStatus = document.getElementById("formStatus");

  const apiKeyInput = document.getElementById("apiKey");
  const categoriesInput = document.getElementById("categories");
  const classifyBtn = document.getElementById("classifyBtn");

  const exportBtn = document.getElementById("exportBtn");
  const resetLikesBtn = document.getElementById("resetLikesBtn");
  const clearBtn = document.getElementById("clearBtn");

  const boardEl = document.getElementById("board");
  const boardHint = document.getElementById("boardHint");

  let noteCounter = 1;
  const GEMINI_MODEL = "gemini-2.5-flash";

  // ==== Firestore ã® notes ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦– ====
  db.collection("notes").orderBy("createdAt")
    .onSnapshot((snapshot) => {
      notes.length = 0;
      snapshot.forEach((doc) => {
        const d = doc.data();
        const createdAt =
          d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;

        notes.push({
          id: d.id,
          name: d.name,
          team: d.team || "",
          text: d.text || "",
          category: d.category || "æœªåˆ†é¡",
          createdAt,
          nichrome: d.nichrome || [],
          nichromeLength: d.nichromeLength || null,
          battery: d.battery || [],
          measure: d.measure || null,
          likes: d.likes || 0
        });
      });

      const maxNum = notes.reduce((max, n) => {
        const num = parseInt(n.id.slice(1), 10);
        return isNaN(num) ? max : Math.max(max, num);
      }, 0);
      noteCounter = maxNum + 1;

      renderBoard();
    });

  // ==== ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆFirestoreã«ä¿å­˜ï¼‰ ====
  addBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim() || "åç„¡ã—";
    const team = teamInput.value.trim();
    const text = commentInput.value.trim();

    const nichrome = [];
    if (nichrome02.checked) nichrome.push("0.2mm");
    if (nichrome04.checked) nichrome.push("0.4mm");
    const nichromeLength = nichromeLen.value ? Number(nichromeLen.value) : null;

    const battery = [];
    if (batSingle.checked) battery.push("1å€‹");
    if (batSeries.checked) battery.push("ç›´åˆ—");
    if (batParallel.checked) battery.push("ä¸¦åˆ—");

    function parseNum(el) {
      return el.value !== "" ? Number(el.value) : null;
    }
    const measure = {
      start: {
        temp: parseNum(sTemp),
        volt: parseNum(sVolt),
        amp:  parseNum(sAmp)
      },
      end: {
        temp: parseNum(eTemp),
        volt: parseNum(eVolt),
        amp:  parseNum(eAmp)
      }
    };

    const id = `N${String(noteCounter).padStart(3, "0")}`;
    noteCounter++;

    formStatus.textContent = "ä¿å­˜ä¸­...";
    formStatus.classList.remove("error");

    try {
      await db.collection("notes").doc(id).set({
        id,
        name,
        team,
        text,
        category: "æœªåˆ†é¡",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nichrome,
        nichromeLength,
        battery,
        measure,
        likes: 0
      });

      commentInput.value = "";
      nichrome02.checked = false;
      nichrome04.checked = false;
      nichromeLen.value = "";
      batSingle.checked = batSeries.checked = batParallel.checked = false;
      sTemp.value = sVolt.value = sAmp.value = "";
      eTemp.value = eVolt.value = eAmp.value = "";

      formStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚";
      setTimeout(() => (formStatus.textContent = ""), 1500);
    } catch (e) {
      console.error(e);
      formStatus.textContent = "ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      formStatus.classList.add("error");
    }
  });

  // Cmd/Ctrl+Enter ã§ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
  commentInput.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
      e.preventDefault();
      addBtn.click();
    }
  });

  // ==== CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ====
  function csvEscape(value) {
    const v = (value ?? "").toString().replace(/"/g, '""');
    return `"${v}"`;
  }

  // ==== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ ====
  exportBtn.addEventListener("click", () => {
    if (notes.length === 0) {
      alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const header = [
      "id",
      "name",
      "team",
      "text",
      "category",
      "createdAt",
      "nichrome",
      "nichromeLength",
      "battery",
      "start_temp",
      "start_volt",
      "start_amp",
      "end_temp",
      "end_volt",
      "end_amp",
      "likes"
    ];
    const lines = [header.join(",")];

    notes.forEach((n) => {
      const created =
        n.createdAt instanceof Date
          ? n.createdAt.toISOString()
          : (n.createdAt || "");

      const m = n.measure || { start: {}, end: {} };
      const row = [
        n.id,
        n.name,
        n.team,
        n.text,
        n.category,
        created,
        (n.nichrome || []).join("/"),
        n.nichromeLength ?? "",
        (n.battery || []).join("/"),
        m.start?.temp ?? "",
        m.start?.volt ?? "",
        m.start?.amp ?? "",
        m.end?.temp ?? "",
        m.end?.volt ?? "",
        m.end?.amp ?? "",
        n.likes ?? 0
      ].map(csvEscape).join(",");
      lines.push(row);
    });

    const csv = lines.join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const now = new Date();
    const pad = (num) => String(num).padStart(2, "0");
    const filename =
      `dennetsusen_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_` +
      `${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.csv`;

    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ==== ã„ã„ã­ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ ====
  resetLikesBtn.addEventListener("click", async () => {
    if (notes.length === 0) {
      alert("ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã„ã„ã­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    const ok = confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã®ã€ã„ã„ã­ã€ã‚’ 0 ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (!ok) return;

    resetLikesBtn.disabled = true;
    const originalText = resetLikesBtn.textContent;
    resetLikesBtn.textContent = "ãƒªã‚»ãƒƒãƒˆä¸­...";

    try {
      const snapshot = await db.collection("notes").get();
      const batch = db.batch();
      snapshot.forEach((doc) => {
        batch.update(doc.ref, { likes: 0 });
      });
      await batch.commit();
      alert("ã™ã¹ã¦ã®ã€ã„ã„ã­ã€ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
    } catch (e) {
      console.error(e);
      alert("ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      resetLikesBtn.disabled = false;
      resetLikesBtn.textContent = originalText;
    }
  });

  // ==== ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆå…¨å‰Šé™¤ï¼‰ ====
  clearBtn.addEventListener("click", async () => {
    if (notes.length === 0) {
      alert("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const ok = confirm(
      "ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰"
    );
    if (!ok) return;

    clearBtn.disabled = true;
    const originalText = clearBtn.textContent;
    clearBtn.textContent = "å‰Šé™¤ä¸­...";

    try {
      const snapshot = await db.collection("notes").get();
      const batch = db.batch();
      snapshot.forEach((doc) => batch.delete(doc.ref));
      await batch.commit();
      alert("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    } catch (e) {
      console.error(e);
      alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      clearBtn.disabled = false;
      clearBtn.textContent = originalText;
    }
  });

   // ==== ãƒœãƒ¼ãƒ‰æç”» ====
   function renderBoard() {
    boardEl.innerHTML = "";
    if (notes.length === 0) {
      boardHint.textContent = "ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    boardHint.textContent = "";

    const categorySet = new Set();
    notes.forEach(n => categorySet.add(n.category || "æœªåˆ†é¡"));
    const categories = Array.from(categorySet);

    categories.forEach(cat => {
      const col = document.createElement("div");
      col.className = "column";

      const header = document.createElement("div");
      header.className = "column-header";
      const title = document.createElement("div");
      title.textContent = cat;
      const count = document.createElement("div");
      count.className = "column-count";
      count.textContent = `${notes.filter(n => n.category === cat).length} ä»¶`;
      header.appendChild(title);
      header.appendChild(count);
      col.appendChild(header);

      const body = document.createElement("div");
      body.className = "column-body";

      notes
        .filter(n => n.category === cat)
        .forEach(n => {
          const noteEl = document.createElement("div");
          noteEl.className = "note";

          // åå‰ãƒ»ç­
          const authorEl = document.createElement("div");
          authorEl.className = "note-author";
          const left = document.createElement("span");
          left.textContent = n.name;
          const right = document.createElement("span");
          right.className = "note-category";
          right.textContent = n.team || cat;
          authorEl.appendChild(left);
          authorEl.appendChild(right);

          // ã‚³ãƒ¡ãƒ³ãƒˆ
          const textEl = document.createElement("div");
          textEl.className = "note-text";
          textEl.textContent = n.text;

          // --- ãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»é›»æ± ï¼ˆãƒ¡ã‚¿æƒ…å ±ï¼‰---
          const metaParts = [];

          if ((n.nichrome && n.nichrome.length) || n.nichromeLength != null) {
            let s = "ãƒ‹ã‚¯ãƒ­ãƒ ç·š: ";
            if (n.nichrome && n.nichrome.length) {
              s += n.nichrome.join(" / ");
            }
            if (n.nichromeLength != null && n.nichromeLength !== "") {
              if (n.nichrome && n.nichrome.length) s += " / ";
              s += `é•·ã•: ${n.nichromeLength}mm`;
            }
            metaParts.push(s);
          }

          if (n.battery && n.battery.length) {
            metaParts.push("é›»æ± : " + n.battery.join(" / "));
          }

          let metaEl = null;
          if (metaParts.length) {
            metaEl = document.createElement("div");
            metaEl.className = "note-meta";
            metaEl.textContent = metaParts.join("ã€€");
          }

          // --- è¨ˆæ¸¬å€¤ï¼ˆè¡¨ï¼‹ä¸Šæ˜‡æ¸©åº¦ï¼é›»åŠ›ï¼‰---
          let measureWrapper = null;

          if (n.measure) {
            const m = n.measure;
            const start = m.start || {};
            const end   = m.end   || {};

            const hasStart = (
              start.temp !== null && start.temp !== undefined ||
              start.volt !== null && start.volt !== undefined ||
              start.amp  !== null && start.amp  !== undefined
            );
            const hasEnd = (
              end.temp !== null && end.temp !== undefined ||
              end.volt !== null && end.volt !== undefined ||
              end.amp  !== null && end.amp  !== undefined
            );

            // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const fmt = (v, digits = 1) => {
              if (v === null || v === undefined || v === "") return "-";
              const num = Number(v);
              if (Number.isNaN(num)) return "-";
              return Number(num.toFixed(digits));
            };

            // ä¸Šæ˜‡æ¸©åº¦ã¨é›»åŠ›ã®è¨ˆç®—
            let deltaTemp = null;
            if (start.temp != null && end.temp != null) {
              deltaTemp = Number(end.temp) - Number(start.temp);
            }

            let avgVolt = null;
            if (start.volt != null && end.volt != null) {
              avgVolt = (Number(start.volt) + Number(end.volt)) / 2;
            }

            let avgAmp = null;
            if (start.amp != null && end.amp != null) {
              avgAmp = (Number(start.amp) + Number(end.amp)) / 2;
            }

            let power = null;
            if (avgVolt !== null && avgAmp !== null) {
              power = avgVolt * avgAmp;   // W = å¹³å‡é›»åœ§ Ã— å¹³å‡é›»æµ
            }

            measureWrapper = document.createElement("div");
            measureWrapper.className = "note-measure";

            const titleEl = document.createElement("p");
            titleEl.className = "note-measure-title";
            titleEl.textContent = "è¨ˆæ¸¬å€¤";
            measureWrapper.appendChild(titleEl);

            // é–‹å§‹ï¼çµ‚äº†ã®è¡¨
            if (hasStart || hasEnd) {
              const table = document.createElement("table");
              table.className = "measure-board-table";
              table.innerHTML = `
                <thead>
                  <tr>
                    <th></th>
                    <th>æ°´æ¸© â„ƒ</th>
                    <th>é›»åœ§ V</th>
                    <th>é›»æµ A</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>é–‹å§‹</th>
                    <td>${fmt(start.temp, 1)}</td>
                    <td>${fmt(start.volt, 2)}</td>
                    <td>${fmt(start.amp, 2)}</td>
                  </tr>
                  <tr>
                    <th>çµ‚äº†</th>
                    <td>${fmt(end.temp, 1)}</td>
                    <td>${fmt(end.volt, 2)}</td>
                    <td>${fmt(end.amp, 2)}</td>
                  </tr>
                </tbody>
              `;
              measureWrapper.appendChild(table);
            }

            // ä¸Šæ˜‡æ¸©åº¦ãƒ»é›»åŠ›ã‚’åŒã˜è¡Œã®è¡¨ã§è¡¨ç¤º
            if (deltaTemp !== null || power !== null) {
              const table2 = document.createElement("table");
              table2.className = "measure-board-table secondary";
              table2.innerHTML = `
                <thead>
                  <tr>
                    <th>ä¸Šæ˜‡æ¸©åº¦ â„ƒ</th>
                    <th>é›»åŠ› W</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${fmt(deltaTemp, 2)}</td>
                    <td>${fmt(power, 2)}</td>
                  </tr>
                </tbody>
              `;
              measureWrapper.appendChild(table2);
            }
          }

          // --- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆã„ã„ã­ãƒ»å‰Šé™¤ï¼‰---
          const footerEl = document.createElement("div");
          footerEl.className = "note-footer";

          const likeBtn = document.createElement("button");
          likeBtn.type = "button";
          likeBtn.className = "note-btn note-btn-like";
          likeBtn.textContent = "ğŸ’— " + (n.likes ?? 0);

          likeBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            likeBtn.disabled = true;
            try {
              await db.collection("notes")
                .doc(n.id)
                .update({ likes: firebase.firestore.FieldValue.increment(1) });
            } catch (err) {
              console.error(err);
              alert("ã„ã„ã­ã®åæ˜ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
              likeBtn.disabled = false;
            }
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "note-btn note-btn-del";
          delBtn.textContent = "ğŸ—‘ å‰Šé™¤";

          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const ok = confirm(`ã“ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ${n.id}ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
            if (!ok) return;
            try {
              await db.collection("notes").doc(n.id).delete();
            } catch (err) {
              console.error(err);
              alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
          });

          footerEl.appendChild(likeBtn);
          footerEl.appendChild(delBtn);

          // ID
          const idEl = document.createElement("div");
          idEl.className = "note-id";
          idEl.textContent = n.id;

          // ===== ã‚«ãƒ¼ãƒ‰å†…ã®è¡¨ç¤ºé † =====
          noteEl.appendChild(authorEl);           // åå‰ãƒ»ç­
          if (metaEl) noteEl.appendChild(metaEl); // ãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»é›»æ± 
          if (measureWrapper) noteEl.appendChild(measureWrapper); // è¨ˆæ¸¬å€¤è¡¨
          noteEl.appendChild(textEl);             // ã‚³ãƒ¡ãƒ³ãƒˆ
          noteEl.appendChild(footerEl);           // ã„ã„ã­ãƒ»å‰Šé™¤
          noteEl.appendChild(idEl);               // ID

          body.appendChild(noteEl);
        });

      col.appendChild(body);
      boardEl.appendChild(col);
    });
  }


  // ==== Gemini ã«æ¸¡ã™èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ ====
  function buildClassificationText(n) {
    const parts = [];

    if (n.name) parts.push(`åå‰: ${n.name}`);
    if (n.team) parts.push(`ç­: ${n.team}`);

    if (n.createdAt instanceof Date) {
      const d = n.createdAt;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      parts.push(`é€ä¿¡æ—¥æ™‚: ${yyyy}-${mm}-${dd} ${hh}æ™‚${mi}åˆ†`);
    }

    if (n.battery && n.battery.length) {
      parts.push(`é›»æ± : ${n.battery.join(" / ")}`);
    }
    if (n.nichrome && n.nichrome.length) {
      parts.push(`ãƒ‹ã‚¯ãƒ­ãƒ ç·š: ${n.nichrome.join(" / ")}`);
    }
    if (n.nichromeLength != null && n.nichromeLength !== "") {
      parts.push(`ãƒ‹ã‚¯ãƒ­ãƒ ç·šã®é•·ã•: ${n.nichromeLength}mm`);
    }

    if (n.measure) {
      const m = n.measure;
      const startArr = [];
      const endArr = [];

      const start = m.start || {};
      const end   = m.end   || {};

      if (m.start) {
        if (m.start.temp != null) startArr.push(`æ°´æ¸©${m.start.temp}â„ƒ`);
        if (m.start.volt != null) startArr.push(`é›»åœ§${m.start.volt}V`);
        if (m.start.amp  != null) startArr.push(`é›»æµ${m.start.amp}`);
      }
      if (m.end) {
        if (m.end.temp != null) endArr.push(`æ°´æ¸©${m.end.temp}â„ƒ`);
        if (m.end.volt != null) endArr.push(`é›»åœ§${m.end.volt}V`);
        if (m.end.amp  != null) endArr.push(`é›»æµ${m.end.amp}`);
      }
      if (startArr.length) parts.push(`é–‹å§‹æ¸¬å®šå€¤: ${startArr.join(", ")}`);
      if (endArr.length)   parts.push(`çµ‚äº†æ¸¬å®šå€¤: ${endArr.join(", ")}`);

      // --- ä¸Šæ˜‡æ¸©åº¦ã¨é›»åŠ›ã‚‚è¨ˆç®—ã—ã¦å«ã‚ã‚‹ ---
      let deltaTemp = null;
      if (start.temp != null && end.temp != null) {
        deltaTemp = Number(end.temp) - Number(start.temp);
      }

      let avgVolt = null;
      if (start.volt != null && end.volt != null) {
        avgVolt = (Number(start.volt) + Number(end.volt)) / 2;
      }

      let avgAmp = null;
      if (start.amp != null && end.amp != null) {
        avgAmp = (Number(start.amp) + Number(end.amp)) / 2;
      }

      let power = null;
      if (avgVolt !== null && avgAmp !== null) {
        power = avgVolt * avgAmp;
      }

      const fmt = (v, digits = 2) => {
        if (v === null || v === undefined || Number.isNaN(Number(v))) return "-";
        return Number(v).toFixed(digits);
      };

      if (deltaTemp !== null) {
        parts.push(`ä¸Šæ˜‡æ¸©åº¦: ${fmt(deltaTemp, 2)}â„ƒ`);
      }
      if (power !== null) {
        parts.push(`é›»åŠ›: ${fmt(power, 2)}W`);
      }
    }

    if (n.text) {
      parts.push(`ã‚³ãƒ¡ãƒ³ãƒˆ: ${n.text}`);
    }

    if (parts.length === 0) {
      parts.push(`ID:${n.id}`);
    }

    return parts.join(" / ");
  }


  // ==== Gemini ã§åˆ†é¡ ====
  async function classifyNotes() {
    if (notes.length === 0) {
      alert("åˆ†é¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
      alert("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const categoryText = categoriesInput.value.trim();
    if (!categoryText) {
      alert("ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š1å€‹, ç›´åˆ—, ä¸¦åˆ— / 11æ™‚30åˆ†ã€œ12æ™‚ ãªã©ï¼‰");
      return;
    }

    const categories = categoryText.split(",").map(c => c.trim()).filter(Boolean);
    if (categories.length === 0) {
      alert("ã‚«ãƒ†ã‚´ãƒªãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }

    classifyBtn.disabled = true;
    classifyBtn.textContent = "åˆ†é¡ä¸­...";

    try {
      const payloadNotes = notes.map(n => ({
        id: n.id,
        text: buildClassificationText(n)
      }));

      const prompt =
        "ã‚ãªãŸã¯ç†ç§‘å®Ÿé¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n" +
        "å„ comments[i].text ã«ã¯ã€Œåå‰ãƒ»ç­ãƒ»ãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»é›»æ± æ§‹æˆï¼ˆ1å€‹/ç›´åˆ—/ä¸¦åˆ—ãªã©ï¼‰ãƒ»æ¸¬å®šå€¤ãƒ»é€ä¿¡æ—¥æ™‚ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã€ãªã©ã‚’ã¾ã¨ã‚ãŸæ—¥æœ¬èªã®1è¡Œãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã£ã¦ã„ã¾ã™ã€‚\n" +
        "ä¸ãˆã‚‰ã‚ŒãŸ comments é…åˆ—ã®å„è¦ç´ ã«ã€æ—¥æœ¬èªã® 'category' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚\n" +
        "category ã¯æ¬¡ã®ä¸­ã‹ã‚‰å¿…ãš1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ï¼š\n" +
        categories.join(" / ") + "\n\n" +
        "å‡ºåŠ›ã¯ JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã¨ã—ã€ä½™è¨ˆãªèª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ¼ã‚«ãƒ¼ã¯ä¸€åˆ‡æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚\n" +
        "å½¢å¼ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼š\n" +
        "{\"comments\":[{\"id\":\"N001\",\"text\":\"èª¬æ˜æ–‡\",\"category\":\"ç›´åˆ—\"}, ...]}\n\n" +
        "ãã‚Œã§ã¯ã€æ¬¡ã® comments ã‚’åˆ†é¡ã—ã¦ãã ã•ã„ï¼š\n\n" +
        JSON.stringify({ comments: payloadNotes }, null, 2);

      const url =
        "https://generativelanguage.googleapis.com/v1beta/models/" +
        encodeURIComponent(GEMINI_MODEL) +
        ":generateContent?key=" +
        encodeURIComponent(apiKey);

      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            { parts: [{ text: prompt }] }
          ],
          generationConfig: {
            response_mime_type: "application/json"
          }
        })
      });

      if (!response.ok) {
        const text = await response.text();
        console.error("Gemini API error:", text);
        throw new Error("APIã‚¨ãƒ©ãƒ¼: " + response.status);
      }

      const data = await response.json();
      const candidate = data.candidates && data.candidates[0];
      if (!candidate || !candidate.content || !candidate.content.parts) {
        console.error("Unexpected Gemini response:", data);
        throw new Error("Gemini ã‹ã‚‰æœŸå¾…ã—ãŸå¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
      }

      let jsonText = candidate.content.parts
        .map(p => p.text || "")
        .join("")
        .trim();

      const firstBrace = jsonText.indexOf("{");
      const lastBrace = jsonText.lastIndexOf("}");
      if (firstBrace !== -1 && lastBrace !== -1) {
        jsonText = jsonText.slice(firstBrace, lastBrace + 1);
      }

      let parsed;
      try {
        parsed = JSON.parse(jsonText);
      } catch (e) {
        console.error("JSON parse error:", e, jsonText);
        throw new Error("Gemini ã®å‡ºåŠ›ã‚’ JSON ã¨ã—ã¦è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      }

      const classifiedComments = parsed.comments || [];
      const map = new Map();
      classifiedComments.forEach(c => {
        map.set(c.id, c.category);
      });

      notes.forEach(n => {
        const cat = map.get(n.id);
        if (cat) n.category = cat;
      });

      const batch = db.batch();
      notes.forEach((n) => {
        const ref = db.collection("notes").doc(n.id);
        batch.update(ref, { category: n.category });
      });
      await batch.commit();

      renderBoard();
      alert("åˆ†é¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
    } catch (err) {
      console.error(err);
      alert("åˆ†é¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      classifyBtn.disabled = false;
      classifyBtn.textContent = "ğŸ” åˆ†é¡ã™ã‚‹";
    }
  }

  classifyBtn.addEventListener("click", classifyNotes);
</script>

</body>
</html>

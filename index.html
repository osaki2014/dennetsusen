<!DOCTYPE html>
<html lang="ja">
  <!-- Firebase SDKï¼ˆäº’æ›ç‰ˆï¼‰-->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<head>
  <meta charset="UTF-8" />
  <title>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ - Geminiåˆ†é¡ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f5ff;
      --card: #ffffff;
      --ink: #222;
      --accent: #4f46e5;
      --accent-soft: #e0e7ff;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0ebff, #f8fafc);
      color: var(--ink);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: rgba(248, 250, 252, 0.9);
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      padding: 8px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* QRã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
    .qr-button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
    }
    .qr-button:hover {
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }
    .qr-icon {
      width: 20px;
      height: 20px;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect width='40' height='40' fill='%23ffffff'/><rect x='3' y='3' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='23' y='3' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='3' y='23' width='14' height='14' fill='none' stroke='%23000000' stroke-width='3'/><rect x='7' y='7' width='6' height='6' fill='%23000000'/><rect x='27' y='7' width='6' height='6' fill='%23000000'/><rect x='7' y='27' width='6' height='6' fill='%23000000'/><rect x='22' y='22' width='4' height='4' fill='%23000000'/><rect x='30' y='22' width='3' height='7' fill='%23000000'/><rect x='22' y='30' width='7' height='3' fill='%23000000'/></svg>");
      background-size: cover;
      background-position: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
    }
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    label {
      font-size: 0.8rem;
      color: #475569;
      white-space: nowrap;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    select {
      font: inherit;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      min-width: 120px;
      background: #fff;
      outline: none;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }
    button {
      font: inherit;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #cbd5f5;
      color: #475569;
    }
    .btn-ghost-danger {
      background: transparent;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }

    main {
      display: grid;
      grid-template-columns: minmax(260px, 380px) minmax(0, 1fr);
      gap: 16px;
      padding: 12px 16px 24px;
    }
    @media (max-width: 800px) {
      main { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 14px 16px 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .panel p.hint {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: #64748b;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .field-row > * {
      flex: 1 1 0;
      min-width: 0;
    }
    .field-row.small-gap {
      gap: 6px;
      align-items: center;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #cbd5f5;
      font: inherit;
      outline: none;
    }
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .status {
      font-size: 0.8rem;
      color: #64748b;
      min-height: 1.2em;
    }
    .status.error { color: var(--danger); }

    .board {
      display: flex;
      gap: 12px;
      align-items: stretch;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .column {
      flex: 1;
      min-width: 200px;
      background: #f8fafc;
      border-radius: 14px;
      padding: 8px 8px 10px;
      border: 1px dashed #cbd5f5;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 160px);
    }
    .column-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .column-count {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.14);
    }
    .column-body {
      overflow-y: auto;
      display: grid;
      grid-auto-rows: minmax(0, auto);
      gap: 8px;
      padding-right: 2px;
    }

    .note {
      position: relative;
      padding: 10px 10px 10px;
      border-radius: 10px;
      background: #fef9c3;
      box-shadow:
        0 6px 10px rgba(15, 23, 42, 0.2),
        inset 0 0 0 1px rgba(148, 163, 184, 0.2);
      font-size: 0.85rem;
      transform: rotate(-1.5deg);
      transform-origin: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      cursor: default;
      word-break: break-word;
    }
    .note:nth-child(2n) {
      transform: rotate(1.3deg);
      background: #bfdbfe;
    }
    .note:nth-child(3n) {
      transform: rotate(-0.8deg);
      background: #bbf7d0;
    }
    .note:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow:
        0 10px 18px rgba(15, 23, 42, 0.28),
        inset 0 0 0 1px rgba(148, 163, 184, 0.2);
    }
    .note-author {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #1e293b;
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .note-category {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.12);
      color: #020617;
    }
    .note-text { white-space: pre-wrap; margin-bottom: 4px; }
    .note-id {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 0.65rem;
      opacity: 0.5;
    }
    .note-meta {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #475569;
      line-height: 1.4;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #1d296b;
    }

    .chk-label {
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    /* æ¸¬å®šå€¤ãƒ†ãƒ¼ãƒ–ãƒ«ã®å´©ã‚Œé˜²æ­¢ */
    .measure-table {
      display: grid;
      grid-template-columns: 60px 1fr 1fr 1fr;
      gap: 6px;
      width: 100%;
      margin-top: 4px;
    }
    .measure-table input {
      width: 100%;
      min-width: 0;  /* ãƒ•ã‚©ãƒ¼ãƒ ãŒæ¨ªã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      font-size: 0.85rem;
    }
    .measure-table div {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }

    /* QRãƒ¢ãƒ¼ãƒ€ãƒ« */
    #qrOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #qrOverlay.active {
      display: flex;
    }
    .qr-modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
      text-align: center;
      max-width: 320px;
      width: 90%;
    }
    .qr-modal h2 {
      margin: 0 0 4px;
      font-size: 0.95rem;
    }
    .qr-modal p {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #64748b;
    }
    #qrContainer {
      margin: 8px auto 12px;
    }
    #qrClose {
      font-size: 0.8rem;
    }
  </style>
</head>

<body>
<header>
  <h1>
    <button id="qrButton" class="qr-button" type="button" aria-label="QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">
      <span class="qr-icon"></span>
    </button>
    <span>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ï¼ˆGeminiï¼‰</span>
  </h1>
  <!-- ãƒ€ãƒŸãƒ¼ãƒ•ã‚©ãƒ¼ãƒ : Enter ã§å‹æ‰‹ã«é€ä¿¡ã•ã‚Œãªã„ã‚ˆã†ã« -->
  <form class="toolbar" onsubmit="return false;">
    <div class="toolbar-group">
      <label for="apiKey">Gemini APIã‚­ãƒ¼</label>
      <input id="apiKey" type="password" placeholder="AIza..." autocomplete="off" />
    </div>
    <div class="toolbar-group">
      <label for="categories">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</label>
      <input id="categories" type="text" value="è³ªå•, æ„Ÿæƒ³, æ”¹å–„æ¡ˆ, ãã®ä»–" />
    </div>
    <button id="classifyBtn" class="btn-primary" type="button">
      ğŸ” åˆ†é¡ã™ã‚‹
    </button>
  </form>
</header>

<main>
  <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
  <section class="panel">
    <h2>âœ ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </h2>
    <p class="hint">å¿…è¦ãªé …ç›®ã‚’å…¥åŠ›ã—ã€å€‹äººã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>

    <!-- åå‰ãƒ»ç­ -->
    <div class="field-row">
      <div class="field-group">
        <label for="nameInput">åå‰ï¼ˆä»»æ„ï¼‰</label>
        <input id="nameInput" type="text" placeholder="ãŸã‚ã† ãªã©" />
      </div>
      <div class="field-group">
        <label for="teamInput">ç­</label>
        <select id="teamInput">
          <option value="">é¸æŠ</option>
          <option>1ç­</option><option>2ç­</option><option>3ç­</option>
          <option>4ç­</option><option>5ç­</option><option>6ç­</option>
          <option>7ç­</option><option>8ç­</option><option>9ç­</option><option>10ç­</option>
        </select>
      </div>
    </div>

    <!-- ãƒ‹ã‚¯ãƒ­ãƒ ç·šï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰ -->
    <div class="field-group">
      <label>ãƒ‹ã‚¯ãƒ­ãƒ ç·š</label>
      <div class="field-row small-gap">
        <label class="chk-label">
          <input id="nichrome02" type="radio" name="nichromeType" />0.2mm
        </label>
        <label class="chk-label">
          <input id="nichrome04" type="radio" name="nichromeType" />0.4mm
        </label>
        <input id="nichromeLen" type="number" min="0" step="1" placeholder="é•·ã•(mm)" />
      </div>
    </div>

    <!-- é›»æ± ï¼ˆã„ãšã‚Œã‹1ã¤ã ã‘é¸æŠï¼‰ -->
    <div class="field-group">
      <label>é›»æ± ï¼ˆã©ã‚Œã‹1ã¤ï¼‰</label>
      <div class="field-row small-gap">
        <label class="chk-label">
          <input id="batSingle" type="radio" name="batteryType" />1å€‹
        </label>
        <label class="chk-label">
          <input id="batSeries" type="radio" name="batteryType" />ç›´åˆ—
        </label>
        <label class="chk-label">
          <input id="batParallel" type="radio" name="batteryType" />ä¸¦åˆ—
        </label>
      </div>
    </div>

    <!-- æ¸¬å®šå€¤ -->
    <div class="field-group">
      <label>æ¸¬å®šå€¤ï¼ˆé–‹å§‹ï¼çµ‚äº†ï¼‰</label>
      <div class="measure-table">
        <div></div><div>æ°´æ¸© â„ƒ</div><div>é›»åœ§ V</div><div>é›»æµ A</div>

        <div>é–‹å§‹</div>
        <input id="s_temp" type="number" step="0.1" />
        <input id="s_volt" type="number" step="0.1" />
        <input id="s_amp" type="number" step="0.1" />

        <div>çµ‚äº†</div>
        <input id="e_temp" type="number" step="0.1" />
        <input id="e_volt" type="number" step="0.1" />
        <input id="e_amp" type="number" step="0.1" />
      </div>
      <p class="hint">â€» åŠè§’æ•°å­—ã§å°æ•°ç¬¬1ä½ã¾ã§å…¥åŠ›ã§ãã¾ã™</p>
    </div>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰ -->
    <div class="field-group">
      <label for="commentInput">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
      <textarea id="commentInput" placeholder="ã“ã“ã«æ„è¦‹ã‚„æ„Ÿæƒ³ã€è³ªå•ãªã©ã‚’æ›¸ã„ã¦ã‚‚OKã§ã™"></textarea>
    </div>

    <div class="field-row" style="align-items:center; margin-top:4px;">
      <button id="addBtn" class="btn-ghost" type="button">â• ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </button>
      <div id="formStatus" class="status"></div>
    </div>

    <hr style="margin:10px 0; border:none; border-top:1px dashed #e2e8f0;" />

    <p class="hint">
      ä¸Šã®ã€Œåˆ†é¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ Gemini ãŒ
      <span class="badge">ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</span>ã—ã¾ã™ã€‚
    </p>
  </section>

  <!-- ãƒœãƒ¼ãƒ‰ãƒ‘ãƒãƒ« -->
  <section class="panel">
    <h2>ğŸ“Œ ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰</h2>

    <!-- ä¿å­˜ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ -->
    <div class="field-row" style="justify-content:flex-end; margin-bottom:4px;">
      <button id="exportBtn" class="btn-ghost" type="button">ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
      <button id="clearBtn" class="btn-ghost-danger" type="button">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    </div>

    <p class="hint" id="boardHint">
      ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    </p>
    <div id="board" class="board"></div>
  </section>
</main>

<!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qrOverlay">
  <div class="qr-modal">
    <h2>é›»ç†±ç·šãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒœãƒ¼ãƒ‰ å‚åŠ ç”¨QRã‚³ãƒ¼ãƒ‰</h2>
    <p>ã‚¹ãƒãƒ›ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚</p>
    <div id="qrContainer"></div>
    <button id="qrClose" class="btn-ghost" type="button">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
  // ==== QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ====
  const QR_URL = "https://osaki2014.github.io/dennetsusen/";
  const qrButton = document.getElementById("qrButton");
  const qrOverlay = document.getElementById("qrOverlay");
  const qrClose = document.getElementById("qrClose");
  const qrContainer = document.getElementById("qrContainer");
  let qrInstance = null;

  qrButton.addEventListener("click", () => {
    if (!qrInstance) {
      qrInstance = new QRCode(qrContainer, {
        text: QR_URL,
        width: 256,
        height: 256
      });
    }
    qrOverlay.classList.add("active");
  });

  qrClose.addEventListener("click", () => {
    qrOverlay.classList.remove("active");
  });

  qrOverlay.addEventListener("click", (e) => {
    if (e.target === qrOverlay) {
      qrOverlay.classList.remove("active");
    }
  });

  // ==== Firebase è¨­å®š ====
  const firebaseConfig = {
    apiKey: "AIzaSyCPgjXJw9HQ2AUMzgN4O16s7UYjDllO87I",
    authDomain: "aifusen-class.firebaseapp.com",
    projectId: "aifusen-class",
    storageBucket: "aifusen-class.appspot.com",
    messagingSenderId: "414270455525",
    appId: "1:414270455525:web:95444f14ee8306b6af1e0c",
    measurementId: "G-H74HN1KZTY"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ==== ãƒ‡ãƒ¼ã‚¿ç®¡ç† ====
  const notes = [];

  const nameInput = document.getElementById("nameInput");
  const teamInput = document.getElementById("teamInput");
  const commentInput = document.getElementById("commentInput");

  const nichrome02 = document.getElementById("nichrome02");
  const nichrome04 = document.getElementById("nichrome04");
  const nichromeLen = document.getElementById("nichromeLen");

  const batSingle = document.getElementById("batSingle");
  const batSeries = document.getElementById("batSeries");
  const batParallel = document.getElementById("batParallel");

  const sTemp = document.getElementById("s_temp");
  const sVolt = document.getElementById("s_volt");
  const sAmp  = document.getElementById("s_amp");
  const eTemp = document.getElementById("e_temp");
  const eVolt = document.getElementById("e_volt");
  const eAmp  = document.getElementById("e_amp");

  const addBtn = document.getElementById("addBtn");
  const formStatus = document.getElementById("formStatus");

  const apiKeyInput = document.getElementById("apiKey");
  const categoriesInput = document.getElementById("categories");
  const classifyBtn = document.getElementById("classifyBtn");

  const exportBtn = document.getElementById("exportBtn");
  const clearBtn = document.getElementById("clearBtn");

  const boardEl = document.getElementById("board");
  const boardHint = document.getElementById("boardHint");

  let noteCounter = 1;
  const GEMINI_MODEL = "gemini-2.5-flash";

  // ==== Firestore ã® notes ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦– ====
  db.collection("notes").orderBy("createdAt")
    .onSnapshot((snapshot) => {
      notes.length = 0;
      snapshot.forEach((doc) => {
        const d = doc.data();
        const createdAt =
          d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;

        notes.push({
          id: d.id,
          name: d.name,
          team: d.team || d.tag || "",
          text: d.text || "",
          category: d.category || "æœªåˆ†é¡",
          createdAt,
          nichrome: d.nichrome || [],
          nichromeLength: d.nichromeLength || null,
          battery: d.battery || [],
          measure: d.measure || null
        });
      });

      const maxNum = notes.reduce((max, n) => {
        const num = parseInt(n.id.slice(1), 10);
        return isNaN(num) ? max : Math.max(max, num);
      }, 0);
      noteCounter = maxNum + 1;

      renderBoard();
    });

  // ==== ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆFirestoreã«ä¿å­˜ï¼‰ ====
  addBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim() || "åç„¡ã—";
    const team = teamInput.value.trim();   // ç©ºã§ã‚‚OK
    const text = commentInput.value.trim(); // ã‚³ãƒ¡ãƒ³ãƒˆã¯ä»»æ„

    // ãƒ‹ã‚¯ãƒ­ãƒ ç·šï¼ˆradio ãªã®ã§0ã€œ1å€‹ï¼‰
    const nichrome = [];
    if (nichrome02.checked) nichrome.push("0.2mm");
    if (nichrome04.checked) nichrome.push("0.4mm");
    const nichromeLength = nichromeLen.value ? Number(nichromeLen.value) : null;

    // é›»æ± ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãªã®ã§å¿…ãš0ã‹1å€‹ï¼‰
    const battery = [];
    if (batSingle.checked) battery.push("1å€‹");
    if (batSeries.checked) battery.push("ç›´åˆ—");
    if (batParallel.checked) battery.push("ä¸¦åˆ—");

    // æ¸¬å®šå€¤
    function parseNum(el) {
      return el.value !== "" ? Number(el.value) : null;
    }
    const measure = {
      start: {
        temp: parseNum(sTemp),
        volt: parseNum(sVolt),
        amp:  parseNum(sAmp)
      },
      end: {
        temp: parseNum(eTemp),
        volt: parseNum(eVolt),
        amp:  parseNum(eAmp)
      }
    };

    const id = `N${String(noteCounter).padStart(3, "0")}`;
    noteCounter++;

    formStatus.textContent = "ä¿å­˜ä¸­...";
    formStatus.classList.remove("error");

    try {
      await db.collection("notes").doc(id).set({
        id,
        name,
        team,
        text,
        category: "æœªåˆ†é¡",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nichrome,
        nichromeLength,
        battery,
        measure
      });

      // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆï¼ˆåå‰ãƒ»ç­ã¯æ®‹ã™ï¼‰
      commentInput.value = "";
      nichrome02.checked = false;
      nichrome04.checked = false;
      nichromeLen.value = "";
      batSingle.checked = batSeries.checked = batParallel.checked = false;
      sTemp.value = sVolt.value = sAmp.value = "";
      eTemp.value = eVolt.value = eAmp.value = "";

      formStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚";
      setTimeout(() => (formStatus.textContent = ""), 1500);
    } catch (e) {
      console.error(e);
      formStatus.textContent = "ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      formStatus.classList.add("error");
    }
  });

  // Cmd/Ctrl+Enter ã§ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
  commentInput.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
      e.preventDefault();
      addBtn.click();
    }
  });

  // ==== CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ====
  function csvEscape(value) {
    const v = (value ?? "").toString().replace(/"/g, '""');
    return `"${v}"`;
  }

  // ==== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ ====
  exportBtn.addEventListener("click", () => {
    if (notes.length === 0) {
      alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const header = [
      "id",
      "name",
      "team",
      "text",
      "category",
      "createdAt",
      "nichrome",
      "nichromeLength",
      "battery",
      "start_temp",
      "start_volt",
      "start_amp",
      "end_temp",
      "end_volt",
      "end_amp"
    ];
    const lines = [header.join(",")];

    notes.forEach((n) => {
      const created =
        n.createdAt instanceof Date
          ? n.createdAt.toISOString()
          : (n.createdAt || "");

      const m = n.measure || { start: {}, end: {} };
      const row = [
        n.id,
        n.name,
        n.team,
        n.text,
        n.category,
        created,
        (n.nichrome || []).join("/"),
        n.nichromeLength ?? "",
        (n.battery || []).join("/"),
        m.start?.temp ?? "",
        m.start?.volt ?? "",
        m.start?.amp ?? "",
        m.end?.temp ?? "",
        m.end?.volt ?? "",
        m.end?.amp ?? ""
      ].map(csvEscape).join(",");
      lines.push(row);
    });

    const csv = lines.join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const now = new Date();
    const pad = (num) => String(num).padStart(2, "0");
    const filename =
      `dennetsusen_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_` +
      `${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.csv`;

    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ==== ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆå…¨å‰Šé™¤ï¼‰ ====
  clearBtn.addEventListener("click", async () => {
    if (notes.length === 0) {
      alert("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const ok = confirm(
      "ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰"
    );
    if (!ok) return;

    clearBtn.disabled = true;
    clearBtn.textContent = "å‰Šé™¤ä¸­...";

    try {
      const snapshot = await db.collection("notes").get();
      const batch = db.batch();
      snapshot.forEach((doc) => batch.delete(doc.ref));
      await batch.commit();
      alert("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    } catch (e) {
      console.error(e);
      alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      clearBtn.disabled = false;
      clearBtn.textContent = "ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤";
    }
  });

  // ==== ãƒœãƒ¼ãƒ‰æç”» ====
  function renderBoard() {
    boardEl.innerHTML = "";
    if (notes.length === 0) {
      boardHint.textContent = "ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    boardHint.textContent = "";

    const categorySet = new Set();
    notes.forEach(n => categorySet.add(n.category || "æœªåˆ†é¡"));
    const categories = Array.from(categorySet);

    categories.forEach(cat => {
      const col = document.createElement("div");
      col.className = "column";

      const header = document.createElement("div");
      header.className = "column-header";
      const title = document.createElement("div");
      title.textContent = cat;
      const count = document.createElement("div");
      count.className = "column-count";
      count.textContent = `${notes.filter(n => n.category === cat).length} ä»¶`;
      header.appendChild(title);
      header.appendChild(count);
      col.appendChild(header);

      const body = document.createElement("div");
      body.className = "column-body";

      notes
        .filter(n => n.category === cat)
        .forEach(n => {
          const noteEl = document.createElement("div");
          noteEl.className = "note";

          const authorEl = document.createElement("div");
          authorEl.className = "note-author";
          const left = document.createElement("span");
          left.textContent = n.name;
          const right = document.createElement("span");
          right.className = "note-category";
          right.textContent = n.team || cat;
          authorEl.appendChild(left);
          authorEl.appendChild(right);
          noteEl.appendChild(authorEl);

          const textEl = document.createElement("div");
          textEl.className = "note-text";
          textEl.textContent = n.text;
          noteEl.appendChild(textEl);

          // ãƒ¡ã‚¿æƒ…å ±ï¼ˆãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»é›»æ± ãƒ»æ¸¬å®šå€¤ï¼‰
          const metaParts = [];

          if ((n.nichrome && n.nichrome.length) || n.nichromeLength != null) {
            let s = "ãƒ‹ã‚¯ãƒ­ãƒ ç·š: ";
            if (n.nichrome && n.nichrome.length) {
              s += n.nichrome.join(" / ");
            }
            if (n.nichromeLength != null && n.nichromeLength !== "") {
              if (n.nichrome && n.nichrome.length) s += " / ";
              s += `é•·ã•: ${n.nichromeLength}mm`;
            }
            metaParts.push(s);
          }

          if (n.battery && n.battery.length) {
            metaParts.push("é›»æ± : " + n.battery.join(" / "));
          }

          if (n.measure) {
            const m = n.measure;
            function fmt(v) {
              return (v === null || v === undefined || v === "") ? "-" : v;
            }
            metaParts.push(
              `é–‹å§‹: æ°´æ¸© ${fmt(m.start?.temp)}â„ƒ, é›»åœ§ ${fmt(m.start?.volt)}V, é›»æµ ${fmt(m.start?.amp)}`,
              `çµ‚äº†: æ°´æ¸© ${fmt(m.end?.temp)}â„ƒ, é›»åœ§ ${fmt(m.end?.volt)}V, é›»æµ ${fmt(m.end?.amp)}`
            );
          }

          if (metaParts.length) {
            const metaEl = document.createElement("div");
            metaEl.className = "note-meta";
            metaEl.textContent = metaParts.join("ã€€");
            noteEl.appendChild(metaEl);
          }

          const idEl = document.createElement("div");
          idEl.className = "note-id";
          idEl.textContent = n.id;
          noteEl.appendChild(idEl);

          body.appendChild(noteEl);
        });

      col.appendChild(body);
      boardEl.appendChild(col);
    });
  }

  // ==== Gemini ã«æ¸¡ã™èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ ====
  function buildClassificationText(n) {
    const parts = [];

    if (n.name) parts.push(`åå‰: ${n.name}`);
    if (n.team) parts.push(`ç­: ${n.team}`);

    // é€ä¿¡æ™‚åˆ»ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    if (n.createdAt instanceof Date) {
      const d = n.createdAt;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      parts.push(`é€ä¿¡æ—¥æ™‚: ${yyyy}-${mm}-${dd} ${hh}æ™‚${mi}åˆ†`);
    }

    if (n.battery && n.battery.length) {
      parts.push(`é›»æ± : ${n.battery.join(" / ")}`);
    }
    if (n.nichrome && n.nichrome.length) {
      parts.push(`ãƒ‹ã‚¯ãƒ­ãƒ ç·š: ${n.nichrome.join(" / ")}`);
    }
    if (n.nichromeLength != null && n.nichromeLength !== "") {
      parts.push(`ãƒ‹ã‚¯ãƒ­ãƒ ç·šã®é•·ã•: ${n.nichromeLength}mm`);
    }
    if (n.measure) {
      const m = n.measure;
      const start = [];
      const end = [];
      if (m.start) {
        if (m.start.temp != null) start.push(`æ°´æ¸©${m.start.temp}â„ƒ`);
        if (m.start.volt != null) start.push(`é›»åœ§${m.start.volt}V`);
        if (m.start.amp  != null) start.push(`é›»æµ${m.start.amp}`);
      }
      if (m.end) {
        if (m.end.temp != null) end.push(`æ°´æ¸©${m.end.temp}â„ƒ`);
        if (m.end.volt != null) end.push(`é›»åœ§${m.end.volt}V`);
        if (m.end.amp  != null) end.push(`é›»æµ${m.end.amp}`);
      }
      if (start.length) parts.push(`é–‹å§‹æ¸¬å®šå€¤: ${start.join(", ")}`);
      if (end.length)   parts.push(`çµ‚äº†æ¸¬å®šå€¤: ${end.join(", ")}`);
    }
    if (n.text) {
      parts.push(`ã‚³ãƒ¡ãƒ³ãƒˆ: ${n.text}`);
    }

    // ä½•ã‚‚ãªã„ã¨ç©ºæ–‡å­—ã«ãªã‚‹ã®ã§ã€ãã®ã¨ãã ã‘idã‚’å…¥ã‚Œã¦ãŠã
    if (parts.length === 0) {
      parts.push(`ID:${n.id}`);
    }

    return parts.join(" / ");
  }

  // ==== Gemini ã§åˆ†é¡ï¼ˆJSONãƒ¢ãƒ¼ãƒ‰ + ã‚†ã‚‹ã„ãƒ‘ãƒ¼ã‚¹ï¼‰ ====
  async function classifyNotes() {
    if (notes.length === 0) {
      alert("åˆ†é¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
      alert("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const categoryText = categoriesInput.value.trim();
    if (!categoryText) {
      alert("ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š1å€‹, ç›´åˆ—, ä¸¦åˆ— / 11æ™‚30åˆ†ã€œ12æ™‚ ãªã©ï¼‰");
      return;
    }

    const categories = categoryText.split(",").map(c => c.trim()).filter(Boolean);
    if (categories.length === 0) {
      alert("ã‚«ãƒ†ã‚´ãƒªãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }

    classifyBtn.disabled = true;
    classifyBtn.textContent = "åˆ†é¡ä¸­...";

    try {
      // ã‚³ãƒ¡ãƒ³ãƒˆã ã‘ã§ãªãã€åå‰ãƒ»ç­ãƒ»é›»æ± ãƒ»ãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»æ¸¬å®šå€¤ãƒ»é€ä¿¡æ™‚åˆ»ã‚‚å«ã‚ãŸèª¬æ˜æ–‡ã‚’æ¸¡ã™
      const payloadNotes = notes.map(n => ({
        id: n.id,
        text: buildClassificationText(n)
      }));

      const prompt =
        "ã‚ãªãŸã¯ç†ç§‘å®Ÿé¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n" +
        "å„ comments[i].text ã«ã¯ã€Œåå‰ãƒ»ç­ãƒ»ãƒ‹ã‚¯ãƒ­ãƒ ç·šãƒ»é›»æ± æ§‹æˆï¼ˆ1å€‹/ç›´åˆ—/ä¸¦åˆ—ãªã©ï¼‰ãƒ»æ¸¬å®šå€¤ãƒ»é€ä¿¡æ—¥æ™‚ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã€ãªã©ã‚’ã¾ã¨ã‚ãŸæ—¥æœ¬èªã®1è¡Œãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã£ã¦ã„ã¾ã™ã€‚\n" +
        "ä¸ãˆã‚‰ã‚ŒãŸ comments é…åˆ—ã®å„è¦ç´ ã«ã€æ—¥æœ¬èªã® 'category' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚\n" +
        "category ã¯æ¬¡ã®ä¸­ã‹ã‚‰å¿…ãš1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ï¼š\n" +
        categories.join(" / ") + "\n\n" +
        "å‡ºåŠ›ã¯ JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã¨ã—ã€ä½™è¨ˆãªèª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ¼ã‚«ãƒ¼ã¯ä¸€åˆ‡æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚\n" +
        "å½¢å¼ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼š\n" +
        "{\"comments\":[{\"id\":\"N001\",\"text\":\"èª¬æ˜æ–‡\",\"category\":\"ç›´åˆ—\"}, ...]}\n\n" +
        "ãã‚Œã§ã¯ã€æ¬¡ã® comments ã‚’åˆ†é¡ã—ã¦ãã ã•ã„ï¼š\n\n" +
        JSON.stringify({ comments: payloadNotes }, null, 2);

      const url =
        "https://generativelanguage.googleapis.com/v1beta/models/" +
        encodeURIComponent(GEMINI_MODEL) +
        ":generateContent?key=" +
        encodeURIComponent(apiKey);

      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              parts: [{ text: prompt }]
            }
          ],
          generationConfig: {
            response_mime_type: "application/json"
          }
        })
      });

      if (!response.ok) {
        const text = await response.text();
        console.error("Gemini API error:", text);
        throw new Error("APIã‚¨ãƒ©ãƒ¼: " + response.status);
      }

      const data = await response.json();
      const candidate = data.candidates && data.candidates[0];
      if (!candidate || !candidate.content || !candidate.content.parts) {
        console.error("Unexpected Gemini response:", data);
        throw new Error("Gemini ã‹ã‚‰æœŸå¾…ã—ãŸå¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
      }

      let jsonText = candidate.content.parts
        .map(p => p.text || "")
        .join("")
        .trim();

      const firstBrace = jsonText.indexOf("{");
      const lastBrace = jsonText.lastIndexOf("}");
      if (firstBrace !== -1 && lastBrace !== -1) {
        jsonText = jsonText.slice(firstBrace, lastBrace + 1);
      }

      let parsed;
      try {
        parsed = JSON.parse(jsonText);
      } catch (e) {
        console.error("JSON parse error:", e, jsonText);
        throw new Error("Gemini ã®å‡ºåŠ›ã‚’ JSON ã¨ã—ã¦è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      }

      const classifiedComments = parsed.comments || [];
      const map = new Map();
      classifiedComments.forEach(c => {
        map.set(c.id, c.category);
      });

      notes.forEach(n => {
        const cat = map.get(n.id);
        if (cat) n.category = cat;
      });

      // Firestore ã«ã‚‚ã‚«ãƒ†ã‚´ãƒªã‚’åæ˜ 
      const batch = db.batch();
      notes.forEach((n) => {
        const ref = db.collection("notes").doc(n.id);
        batch.update(ref, { category: n.category });
      });
      await batch.commit();

      renderBoard();
      alert("åˆ†é¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
    } catch (err) {
      console.error(err);
      alert("åˆ†é¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      classifyBtn.disabled = false;
      classifyBtn.textContent = "ğŸ” åˆ†é¡ã™ã‚‹";
    }
  }

  classifyBtn.addEventListener("click", classifyNotes);
</script>

</body>
</html>
